# ===================================================
# Configured by Ansible on {{ lookup('pipe','date --iso-8601=seconds') }}
# ===================================================

option domain-name-servers {{ dns_server_1 }}, {{ dns_server_2 }};
default-lease-time 600;
option ntp-servers {{ ntp_server }};
max-lease-time 7200;
authoritative;
ddns-update-style none;

{% if dhcp_failover_master in inventory_hostname %}
failover peer "failover-partner" {
    primary;
    address {{ hosts[dhcp_failover_master].interfaces.management.ip }};
    port 647;
    peer address {{ hosts[dhcp_failover_backup].interfaces.management.ip }};
    peer port 647;
    max-response-delay 30;
    max-unacked-updates 10;
    mclt 1800;
    split 128;
    load balance max seconds 3;
}
{% else %}
failover peer "failover-partner" {
       secondary;
       address {{ hosts[dhcp_failover_backup].interfaces.management.ip }};
       port 7912;
       peer address {{ hosts[dhcp_failover_master].interfaces.management.ip }};
       peer port 7912;
       max-response-delay 30;
       max-unacked-updates 10;
       load balance max seconds 3;
   }
{% endif %}

omapi-port 7911;
omapi-key omapi_key;

key omapi_key {
     algorithm hmac-md5;
     secret "{{ omapi_key }}";
}

{% for subnet in vlans %}
{% if subnet.dhcp == True %}
# {{ subnet.name }} subnet
{% set network = subnet.network|string + '/' + subnet.prefix_length|string %}
subnet {{ network|ipaddr('network')|ipaddr('address') }} netmask {{ network|ipaddr('netmask') }} {
        option routers {{ network|ipaddr('1')|ipaddr('address') }};
        option domain-name "{{ subnet.domain }}";
        option domain-search "{{ subnet.domain }}";
        pool {
          range {{ network|ipaddr('40')|ipaddr('address') }} {{ network|ipaddr('200')|ipaddr('address') }};
          failover peer "failover-partner";
          }
}

{% endif %}
{% endfor %}
log-facility local7;

include "/etc/dhcp/dhcpd-hydra-static.conf";
